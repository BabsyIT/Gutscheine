<!doctype html> 

<html lang="de"> 

 <head> 

  <meta charset="UTF-8"> 

  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 

  <title>Partnergutschein Manager</title> 

  <script src="/_sdk/data_sdk.js"></script>

  <script src="/_sdk/element_sdk.js"></script>

3 Code einloesen  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script> 

  <style> 

    body { 

      box-sizing: border-box; 

      margin: 0; 

      padding: 0; 

      height: 100%; 

    } 

    html { 

      height: 100%; 

    } 

    .voucher-card { 

      transition: transform 0.2s, box-shadow 0.2s; 

    } 

    .voucher-card:hover { 

      transform: translateY(-2px); 

      box-shadow: 0 8px 16px rgba(0,0,0,0.1); 

    } 

    .toast { 

      position: fixed; 

      top: 20px; 

      right: 20px; 

      padding: 16px 24px; 

      border-radius: 8px; 

      box-shadow: 0 4px 12px rgba(0,0,0,0.15); 

      z-index: 1000; 

      animation: slideIn 0.3s ease-out; 

    } 

    @keyframes slideIn { 

      from { 

        transform: translateX(400px); 

        opacity: 0; 

      } 

      to { 

        transform: translateX(0); 

        opacity: 1; 

      } 

    } 

  </style> 

  <style>@view-transition { navigation: auto; }</style> 

 </head> 

 <body> 

  <div id="app" class="min-h-full flex flex-col"><!-- Header --> 

   <header class="shadow-sm"> 

    <div class="max-w-6xl mx-auto px-6 py-4"> 

     <div class="flex justify-between items-center"> 

      <h1 id="page-title" class="text-3xl font-bold">Babsy Partnergutscheine</h1><!-- Desktop Menu --> 

      <nav class="hidden md:flex space-x-6"><button id="nav-home" class="px-4 py-2 rounded-lg font-medium transition-colors"> üè† Startseite </button> <button id="nav-vouchers" class="px-4 py-2 rounded-lg font-medium transition-colors"> üé´ Meine Gutscheine </button> <button id="nav-create" class="px-4 py-2 rounded-lg font-medium transition-colors"> ‚ú® Erstellen </button> <button id="nav-redeem" class="px-4 py-2 rounded-lg font-medium transition-colors"> üéÅ Einl√∂sen </button> 

      </nav><!-- Mobile Menu Button --> <button id="mobile-menu-btn" class="md:hidden p-2 rounded-lg"> 

       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path> 

       </svg></button> 

     </div><!-- Mobile Menu --> 

     <nav id="mobile-menu" class="hidden md:hidden mt-4 space-y-2"><button id="mobile-nav-home" class="w-full text-left px-4 py-2 rounded-lg font-medium transition-colors"> üè† Startseite </button> <button id="mobile-nav-vouchers" class="w-full text-left px-4 py-2 rounded-lg font-medium transition-colors"> üé´ Meine Gutscheine </button> <button id="mobile-nav-create" class="w-full text-left px-4 py-2 rounded-lg font-medium transition-colors"> ‚ú® Erstellen </button> <button id="mobile-nav-redeem" class="w-full text-left px-4 py-2 rounded-lg font-medium transition-colors"> üéÅ Einl√∂sen </button> 

     </nav> 

    </div> 

   </header><!-- Main Content --> 

   <main class="flex-1 max-w-6xl mx-auto px-6 py-8 w-full"><!-- Registration Form --> 

    <div class="mb-8 p-6 rounded-lg shadow-md" style="background-color: #ffffff"> 

     <h2 class="text-2xl font-bold mb-4">Registrierung f√ºr Partnergutscheine</h2> 

     <form id="registration-form" class="grid grid-cols-1 md:grid-cols-2 gap-4"> 

      <div><label for="first-name" class="block font-semibold mb-2">Vorname *</label> <input type="text" id="first-name" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2"> 

      </div> 

      <div><label for="last-name" class="block font-semibold mb-2">Nachname *</label> <input type="text" id="last-name" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2"> 

      </div> 

      <div class="md:col-span-2"><label for="email" class="block font-semibold mb-2">E-Mail-Adresse *</label> <input type="email" id="email" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2"> 

      </div> 

      <div class="md:col-span-2 space-y-3"> 

       <div class="flex items-center"><input type="checkbox" id="app-user" class="mr-3 w-4 h-4"> <label for="app-user" class="font-medium">Ich bin App-User</label> 

       </div> 

       <div class="flex items-center"><input type="checkbox" id="club-member" class="mr-3 w-4 h-4"> <label for="club-member" class="font-medium">Ich bin Vereinsmitglied</label> 

       </div> 

       <div class="flex items-start"><input type="checkbox" id="newsletter" required class="mr-3 w-4 h-4 mt-1"> <label for="newsletter" class="font-medium"> Ich stimme dem Erhalt des Newsletters zu. Dies ist eine Bedingung f√ºr die Nutzung der Plattform. * </label> 

       </div> 

      </div> 

      <div class="md:col-span-2"><button type="submit" id="register-btn" class="w-full px-6 py-3 rounded-lg font-semibold transition-colors"> Registrieren </button> 

      </div> 

     </form> 

    </div><!-- Action Buttons --> 

    <div class="flex gap-4 mb-8"><button id="create-btn" class="px-6 py-3 rounded-lg font-semibold transition-colors"> ‚ú® Gutschein erstellen </button> <button id="redeem-btn" class="px-6 py-3 rounded-lg font-semibold transition-colors"> üéÅ Gutschein einl√∂sen </button> 

    </div><!-- Voucher List -->

    <div>

     <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">Meine Gutscheine</h2>
      <button onclick="exportVouchersJSON()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors flex items-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
       Export PDF
      </button>
     </div>

     <div id="voucher-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"><!-- Vouchers will be rendered here --> 

     </div> 

     <div id="empty-state" class="text-center py-12 hidden"> 

      <div class="text-6xl mb-4"> 

       üé´ 

      </div> 

      <p class="text-xl mb-2">Noch keine Gutscheine</p> 

      <p>Erstelle deinen ersten Gutschein!</p> 

     </div> 

    </div> 

   </main><!-- Create Modal --> 

   <div id="create-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"> 

    <div class="absolute inset-0 bg-black bg-opacity-50" id="create-modal-backdrop"></div> 

    <div class="relative rounded-lg shadow-xl max-w-md w-full p-6"> 

     <h3 class="text-2xl font-bold mb-4">Neuen Gutschein erstellen</h3> 

     <form id="create-form"> 

      <div class="mb-6"><label for="voucher-partner" class="block font-semibold mb-2">Gutschein ausw√§hlen</label> <select id="voucher-partner" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 bg-white"> <option value="">Bitte Gutschein ausw√§hlen...</option> <option value="Restaurant Bella Vista|Abendessen f√ºr 2 Personen|Genie√üen Sie ein romantisches 3-G√§nge-Men√º">üçΩÔ∏è Restaurant Bella Vista - Abendessen f√ºr 2 Personen</option> <option value="Wellness Oase|60 Min Entspannungsmassage|Lassen Sie sich bei einer wohltuenden Ganzk√∂rpermassage verw√∂hnen">üíÜ‚Äç‚ôÄÔ∏è Wellness Oase - 60 Min Entspannungsmassage</option> <option value="Kino Metropol|2 Kinokarten + Popcorn|Erleben Sie die neuesten Blockbuster mit Snacks">üé¨ Kino Metropol - 2 Kinokarten + Popcorn</option> <option value="Fitness Studio Power|1 Monat Mitgliedschaft|Trainieren Sie einen Monat kostenlos in unserem Studio">üí™ Fitness Studio Power - 1 Monat Mitgliedschaft</option> <option value="Caf√© Gem√ºtlich|Kaffee &amp; Kuchen f√ºr 2|Genie√üen Sie hausgemachten Kuchen mit frischem Kaffee">‚òï Caf√© Gem√ºtlich - Kaffee &amp; Kuchen f√ºr 2</option> <option value="Buchhandlung Lesezeit|B√ºchergutschein 25‚Ç¨|St√∂bern Sie in unserem Sortiment und w√§hlen Sie Ihre Lieblingsb√ºcher">üìö Buchhandlung Lesezeit - B√ºchergutschein 25‚Ç¨</option> <option value="Friseur Sch√∂nheit|Waschen, Schneiden, F√∂hnen|Lassen Sie sich von unserem Profi-Team verw√∂hnen">‚úÇÔ∏è Friseur Sch√∂nheit - Waschen, Schneiden, F√∂hnen</option> <option value="Blumen Paradies|Blumenstrau√ü nach Wahl|√úberraschen Sie Ihre Liebsten mit einem frischen Blumenstrau√ü">üå∏ Blumen Paradies - Blumenstrau√ü nach Wahl</option> <option value="B√§ckerei Goldkruste|Fr√ºhst√ºck f√ºr 2 Personen|Starten Sie den Tag mit frischen Backwaren und Kaffee">ü•ñ B√§ckerei Goldkruste - Fr√ºhst√ºck f√ºr 2 Personen</option> <option value="Apotheke Gesundheit|Beratung + Wellness-Paket|Professionelle Beratung mit hochwertigen Wellness-Produkten">üíä Apotheke Gesundheit - Beratung + Wellness-Paket</option> </select> 

      </div> 

      <div class="flex gap-3"><button type="submit" id="create-submit-btn" class="flex-1 px-6 py-3 rounded-lg font-semibold transition-colors"> Gutschein erstellen </button> <button type="button" id="create-cancel-btn" class="flex-1 px-6 py-3 rounded-lg font-semibold transition-colors"> Abbrechen </button> 

      </div> 

     </form> 

    </div> 

   </div><!-- Redeem Modal --> 

   <div id="redeem-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"> 

    <div class="absolute inset-0 bg-black bg-opacity-50" id="redeem-modal-backdrop"></div> 

    <div class="relative rounded-lg shadow-xl max-w-md w-full p-6"> 

     <h3 class="text-2xl font-bold mb-4">Gutschein einl√∂sen</h3> 

     <form id="redeem-form"> 

      <div class="mb-6"><label for="redeem-code" class="block font-semibold mb-2">Gutschein-Code</label> <input type="text" id="redeem-code" required placeholder="XXXX-XXXX" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 uppercase"> 

      </div> 

      <div class="flex gap-3"><button type="submit" id="redeem-submit-btn" class="flex-1 px-6 py-3 rounded-lg font-semibold transition-colors"> Einl√∂sen </button> <button type="button" id="redeem-cancel-btn" class="flex-1 px-6 py-3 rounded-lg font-semibold transition-colors"> Abbrechen </button> 

      </div> 

     </form> 

    </div> 

   </div> 

  </div> 

  <script> 

    const defaultConfig = { 

      background_color: "#f3f4f6", 

      card_color: "#ffffff", 

      text_color: "#1f2937", 

      primary_action_color: "#a71a80", 

      secondary_action_color: "#009fad", 

      page_title: "Babsy Partnergutscheine", 

      create_button_text: "Gutschein erstellen", 

      redeem_button_text: "Gutschein einl√∂sen", 

      font_family: "system-ui", 

      font_size: 16 

    }; 

 

    let vouchers = []; 

 

    function generateVoucherCode() { 

      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; 

      let code = ''; 

      for (let i = 0; i < 8; i++) { 

        if (i === 4) code += '-'; 

        code += chars.charAt(Math.floor(Math.random() * chars.length)); 

      } 

      return code; 

    } 

 

    function showToast(message, type = 'success') { 

      const toast = document.createElement('div'); 

      toast.className = 'toast'; 

      toast.style.backgroundColor = type === 'success' ? '#a71a80' : '#dc2626'; 

      toast.style.color = '#ffffff'; 

      toast.textContent = message; 

      document.body.appendChild(toast); 

      setTimeout(() => toast.remove(), 3000); 

    } 

 

    function renderVouchers() { 

      const voucherList = document.getElementById('voucher-list'); 

      const emptyState = document.getElementById('empty-state'); 

      const config = window.elementSdk?.config || defaultConfig; 

 

      if (vouchers.length === 0) { 

        voucherList.innerHTML = ''; 

        emptyState.classList.remove('hidden'); 

        emptyState.style.color = config.text_color || defaultConfig.text_color; 

        return; 

      } 

 

      emptyState.classList.add('hidden'); 

      voucherList.innerHTML = vouchers.map(voucher => ` 

        <div class="voucher-card rounded-lg shadow-md p-6" style="background-color: ${config.card_color || defaultConfig.card_color}"> 

          <div class="flex justify-between items-start mb-3"> 

            <h3 class="text-xl font-bold" style="color: ${config.text_color || defaultConfig.text_color}">${voucher.title}</h3> 

            <span class="px-3 py-1 rounded-full text-sm font-semibold" style="background-color: ${voucher.isRedeemed ? '#fed7d7' : '#d1fae5'}; color: ${voucher.isRedeemed ? '#991b1b' : '#166534'}"> 

              ${voucher.isRedeemed ? '‚úì Eingel√∂st' : '‚óè Aktiv'} 

            </span> 

          </div> 

          <p class="mb-3" style="color: ${config.text_color || defaultConfig.text_color}">${voucher.description}</p> 

          <div class="mb-3 p-3 rounded" style="background-color: ${config.background_color || defaultConfig.background_color}"> 

            <p class="text-sm font-semibold mb-1" style="color: ${config.text_color || defaultConfig.text_color}">Partner:</p> 

            <p class="font-bold" style="color: ${config.secondary_action_color || defaultConfig.secondary_action_color}">${voucher.partner}</p> 

          </div> 

          <div class="mb-4 p-3 rounded" style="background-color: ${config.background_color || defaultConfig.background_color}"> 

            <p class="text-sm font-semibold mb-1" style="color: ${config.text_color || defaultConfig.text_color}">Wert:</p> 

            <p class="font-bold" style="color: ${config.primary_action_color || defaultConfig.primary_action_color}">${voucher.value}</p> 

          </div> 

          <div class="mb-3 p-3 rounded border-2 border-dashed" style="border-color: ${config.secondary_action_color || defaultConfig.secondary_action_color}"> 

            <p class="text-sm font-semibold mb-1" style="color: ${config.text_color || defaultConfig.text_color}">Code:</p> 

            <p class="font-mono font-bold text-lg" style="color: ${config.text_color || defaultConfig.text_color}">${voucher.code}</p> 

          </div> 

          ${voucher.isRedeemed ? `<p class="text-sm" style="color: ${config.secondary_action_color || defaultConfig.secondary_action_color}">Eingel√∂st am: ${new Date(voucher.redeemedAt).toLocaleDateString('de-DE')}</p>` : ''} 

        </div> 

      `).join(''); 

    } 

 

    async function onConfigChange(config) { 

      const baseFont = config.font_family || defaultConfig.font_family; 

      const baseFontSize = config.font_size || defaultConfig.font_size; 

      const fontStack = `${baseFont}, system-ui, -apple-system, sans-serif`; 

 

      document.body.style.backgroundColor = config.background_color || defaultConfig.background_color; 

      document.body.style.fontFamily = fontStack; 

      document.body.style.fontSize = `${baseFontSize}px`; 

      document.body.style.color = config.text_color || defaultConfig.text_color; 

 

      document.querySelector('header').style.backgroundColor = config.card_color || defaultConfig.card_color; 

      document.getElementById('page-title').textContent = config.page_title || defaultConfig.page_title; 

      document.getElementById('page-title').style.color = config.text_color || defaultConfig.text_color; 

      document.getElementById('page-title').style.fontSize = `${baseFontSize * 2}px`; 

 

      const h2Elements = document.querySelectorAll('h2'); 

      h2Elements.forEach(h2 => { 

        h2.style.color = config.text_color || defaultConfig.text_color; 

        h2.style.fontSize = `${baseFontSize * 1.5}px`; 

      }); 

 

      const createBtn = document.getElementById('create-btn'); 

      createBtn.textContent = `‚ú® ${config.create_button_text || defaultConfig.create_button_text}`; 

      createBtn.style.backgroundColor = config.primary_action_color || defaultConfig.primary_action_color; 

      createBtn.style.color = '#ffffff'; 

 

      const redeemBtn = document.getElementById('redeem-btn'); 

      redeemBtn.textContent = `üéÅ ${config.redeem_button_text || defaultConfig.redeem_button_text}`; 

      redeemBtn.style.backgroundColor = config.secondary_action_color || defaultConfig.secondary_action_color; 

      redeemBtn.style.color = '#ffffff'; 

 

      const registerBtn = document.getElementById('register-btn'); 

      registerBtn.style.backgroundColor = config.primary_action_color || defaultConfig.primary_action_color; 

      registerBtn.style.color = '#ffffff'; 

 

      const modals = document.querySelectorAll('#create-modal > div:last-child, #redeem-modal > div:last-child'); 

      modals.forEach(modal => { 

        modal.style.backgroundColor = config.card_color || defaultConfig.card_color; 

      }); 

 

      const modalTitles = document.querySelectorAll('#create-modal h3, #redeem-modal h3'); 

      modalTitles.forEach(title => { 

        title.style.color = config.text_color || defaultConfig.text_color; 

        title.style.fontSize = `${baseFontSize * 1.5}px`; 

      }); 

 

      const labels = document.querySelectorAll('label'); 

      labels.forEach(label => { 

        label.style.color = config.text_color || defaultConfig.text_color; 

        label.style.fontSize = `${baseFontSize}px`; 

      }); 

 

      const inputs = document.querySelectorAll('input, textarea, select'); 

      inputs.forEach(input => { 

        input.style.borderColor = config.secondary_action_color || defaultConfig.secondary_action_color; 

        input.style.color = config.text_color || defaultConfig.text_color; 

        input.style.fontSize = `${baseFontSize}px`; 

      }); 

 

      const submitButtons = document.querySelectorAll('#create-submit-btn, #redeem-submit-btn'); 

      submitButtons.forEach(btn => { 

        btn.style.backgroundColor = config.primary_action_color || defaultConfig.primary_action_color; 

        btn.style.color = '#ffffff'; 

      }); 

 

      const cancelButtons = document.querySelectorAll('#create-cancel-btn, #redeem-cancel-btn'); 

      cancelButtons.forEach(btn => { 

        btn.style.backgroundColor = config.secondary_action_color || defaultConfig.secondary_action_color; 

        btn.style.color = '#ffffff'; 

      }); 

 

      // Style menu buttons 

      const menuButtons = document.querySelectorAll('#nav-home, #nav-vouchers, #nav-create, #nav-redeem, #mobile-nav-home, #mobile-nav-vouchers, #mobile-nav-create, #mobile-nav-redeem'); 

      menuButtons.forEach(btn => { 

        btn.style.color = config.text_color || defaultConfig.text_color; 

      }); 

 

      const mobileMenuBtn = document.getElementById('mobile-menu-btn'); 

      mobileMenuBtn.style.color = config.text_color || defaultConfig.text_color; 

 

      renderVouchers(); 

    } 

 

    // Load vouchers ONLY from central database (vouchers.json)
    async function loadVouchers() {
      // Get current user from session
      let session = localStorage.getItem('babsy_voucher_session');
      let currentUser = null;

      if (session) {
        try {
          const sessionData = JSON.parse(session);
          currentUser = {
            userId: sessionData.userId,
            username: sessionData.username,
            name: sessionData.name
          };
        } catch (e) {
          console.error('Session parse error:', e);
        }
      }

      if (!currentUser) {
        const username = prompt('Bitte geben Sie Ihren Benutzernamen ein:\n\nBeispiele: mitglied1, mitglied2, demo, admin');
        if (!username) {
          showToast('Bitte melden Sie sich an', 'error');
          return;
        }

        // Authenticate user
        currentUser = await authenticateUser(username);

        if (!currentUser) {
          showToast('Benutzername nicht gefunden', 'error');
          return;
        }

        // Create session
        const sessionData = {
          userId: currentUser.userId,
          username: currentUser.username,
          name: currentUser.name,
          userType: currentUser.userType || 'member',
          loginTime: new Date().toISOString()
        };
        localStorage.setItem('babsy_voucher_session', JSON.stringify(sessionData));
      }

      try {
        // Load ONLY from central database
        const response = await fetch('data/vouchers.json?t=' + Date.now()); // Cache-Buster
        const centralData = await response.json();

        // Filter vouchers for current user
        vouchers = centralData.vouchers.filter(v =>
          v.userId === currentUser.userId ||
          v.customerId === currentUser.username ||
          v.customerId === currentUser.userId
        ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        console.log(`üìä ${vouchers.length} Gutscheine f√ºr ${currentUser.name} aus vouchers.json geladen`);

      } catch (error) {
        console.error('‚ö†Ô∏è Fehler beim Laden von vouchers.json:', error);
        vouchers = [];
        showToast('Fehler beim Laden der Gutscheine', 'error');
      }

      renderVouchers();
    }

    // Authenticate user (same as gutscheine.html)
    async function authenticateUser(username) {
      try {
        // Try Mitglieder
        const memberResponse = await fetch('data/mitglieder-auth.json');
        const memberData = await memberResponse.json();
        const member = memberData.members.find(m => m.username === username);

        if (member) {
          return {
            userId: member.id,
            username: member.username,
            name: member.name,
            userType: 'member'
          };
        }

        // Try Partner
        const partnerResponse = await fetch('data/partners-auth.json');
        const partnerData = await partnerResponse.json();
        const partner = partnerData.partners.find(p => p.username === username);

        if (partner) {
          return {
            userId: partner.id,
            username: partner.username,
            name: partner.partnerName,
            userType: 'partner'
          };
        }

        // Try Employee/Admin
        const employeeResponse = await fetch('data/users.json');
        const employeeData = await employeeResponse.json();
        const employee = employeeData.users.find(u => u.username === username);

        if (employee) {
          return {
            userId: employee.id,
            username: employee.username,
            name: employee.name,
            userType: 'employee'
          };
        }

        return null;
      } catch (error) {
        console.error('Authentication error:', error);
        return null;
      }
    }

    // Save vouchers - adds to pending changes for export
    async function saveVouchers() {
      // Store all vouchers in a pending export queue
      const allVouchers = JSON.parse(localStorage.getItem('pending_vouchers_export') || '[]');

      // Merge: Remove duplicates and add new ones
      const voucherMap = new Map();
      allVouchers.forEach(v => voucherMap.set(v.id, v));
      vouchers.forEach(v => voucherMap.set(v.id, v));

      const mergedVouchers = Array.from(voucherMap.values());
      localStorage.setItem('pending_vouchers_export', JSON.stringify(mergedVouchers));

      console.log('üíæ √Ñnderungen gespeichert - Bereit f√ºr Export');
      showToast('√Ñnderung gespeichert - Bitte exportieren Sie die Daten!', 'warning');

      return true;
    }

    // Export vouchers as PDF
    function exportVouchersJSON() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Get session info
      const session = localStorage.getItem('babsy_voucher_session');
      const currentUser = session ? JSON.parse(session) : { name: 'Unbekannt' };

      // Title
      doc.setFontSize(20);
      doc.setTextColor(0, 159, 173); // Babsy color
      doc.text('Babsy Partnergutscheine', 105, 20, { align: 'center' });

      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      doc.text(`Benutzer: ${currentUser.name}`, 105, 30, { align: 'center' });
      doc.text(`Exportiert am: ${new Date().toLocaleDateString('de-DE')}`, 105, 37, { align: 'center' });

      // Statistics
      const total = vouchers.length;
      const active = vouchers.filter(v => !v.isRedeemed).length;
      const redeemed = vouchers.filter(v => v.isRedeemed).length;

      doc.setFontSize(10);
      doc.text(`Gesamt: ${total} | Aktiv: ${active} | Eingel√∂st: ${redeemed}`, 105, 44, { align: 'center' });

      // Line separator
      doc.setDrawColor(200, 200, 200);
      doc.line(20, 48, 190, 48);

      let yPos = 58;

      if (vouchers.length === 0) {
        doc.setFontSize(12);
        doc.text('Keine Gutscheine vorhanden', 105, yPos, { align: 'center' });
      } else {
        vouchers.forEach((voucher, index) => {
          // Check if we need a new page
          if (yPos > 270) {
            doc.addPage();
            yPos = 20;
          }

          // Voucher box
          doc.setDrawColor(0, 159, 173);
          doc.setLineWidth(0.5);
          doc.rect(20, yPos - 5, 170, 35);

          // Status badge
          if (voucher.isRedeemed) {
            doc.setFillColor(239, 68, 68); // Red
            doc.setTextColor(255, 255, 255);
          } else {
            doc.setFillColor(16, 185, 129); // Green
            doc.setTextColor(255, 255, 255);
          }
          doc.roundedRect(160, yPos - 3, 25, 6, 2, 2, 'F');
          doc.setFontSize(8);
          doc.text(voucher.isRedeemed ? 'Eingel√∂st' : 'Aktiv', 172.5, yPos + 1, { align: 'center' });

          // Voucher details
          doc.setTextColor(0, 0, 0);
          doc.setFontSize(11);
          doc.setFont(undefined, 'bold');
          doc.text(`${voucher.partner}`, 25, yPos + 2);

          doc.setFont(undefined, 'normal');
          doc.setFontSize(9);
          doc.text(`Code: ${voucher.code}`, 25, yPos + 8);
          doc.text(`${voucher.title || voucher.value}`, 25, yPos + 14);

          doc.setFontSize(8);
          doc.setTextColor(100, 100, 100);
          doc.text(`Erstellt: ${new Date(voucher.createdAt).toLocaleDateString('de-DE')}`, 25, yPos + 20);

          if (voucher.isRedeemed && voucher.redeemedAt) {
            doc.text(`Eingel√∂st: ${new Date(voucher.redeemedAt).toLocaleDateString('de-DE')}`, 25, yPos + 25);
          }

          yPos += 42;
        });
      }

      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(`Seite ${i} von ${pageCount}`, 105, 290, { align: 'center' });
      }

      // Save PDF
      doc.save(`Babsy_Gutscheine_${currentUser.name}_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    async function init() {
      // Load vouchers
      await loadVouchers();

      if (window.elementSdk) { 

        window.elementSdk.init({ 

          defaultConfig, 

          onConfigChange, 

          mapToCapabilities: (config) => ({ 

            recolorables: [ 

              { 

                get: () => config.background_color || defaultConfig.background_color, 

                set: (value) => { 

                  config.background_color = value; 

                  window.elementSdk.setConfig({ background_color: value }); 

                } 

              }, 

              { 

                get: () => config.card_color || defaultConfig.card_color, 

                set: (value) => { 

                  config.card_color = value; 

                  window.elementSdk.setConfig({ card_color: value }); 

                } 

              }, 

              { 

                get: () => config.text_color || defaultConfig.text_color, 

                set: (value) => { 

                  config.text_color = value; 

                  window.elementSdk.setConfig({ text_color: value }); 

                } 

              }, 

              { 

                get: () => config.primary_action_color || defaultConfig.primary_action_color, 

                set: (value) => { 

                  config.primary_action_color = value; 

                  window.elementSdk.setConfig({ primary_action_color: value }); 

                } 

              }, 

              { 

                get: () => config.secondary_action_color || defaultConfig.secondary_action_color, 

                set: (value) => { 

                  config.secondary_action_color = value; 

                  window.elementSdk.setConfig({ secondary_action_color: value }); 

                } 

              } 

            ], 

            borderables: [], 

            fontEditable: { 

              get: () => config.font_family || defaultConfig.font_family, 

              set: (value) => { 

                config.font_family = value; 

                window.elementSdk.setConfig({ font_family: value }); 

              } 

            }, 

            fontSizeable: { 

              get: () => config.font_size || defaultConfig.font_size, 

              set: (value) => { 

                config.font_size = value; 

                window.elementSdk.setConfig({ font_size: value }); 

              } 

            } 

          }), 

          mapToEditPanelValues: (config) => new Map([ 

            ["page_title", config.page_title || defaultConfig.page_title], 

            ["create_button_text", config.create_button_text || defaultConfig.create_button_text], 

            ["redeem_button_text", config.redeem_button_text || defaultConfig.redeem_button_text] 

          ]) 

        }); 

      } 

 

      await onConfigChange(window.elementSdk?.config || defaultConfig); 

 

      // Menu Event Listeners 

      document.getElementById('mobile-menu-btn').addEventListener('click', () => { 

        const mobileMenu = document.getElementById('mobile-menu'); 

        mobileMenu.classList.toggle('hidden'); 

      }); 

 

      // Navigation handlers 

      function scrollToSection(sectionId) { 

        const section = document.getElementById(sectionId); 

        if (section) { 

          section.scrollIntoView({ behavior: 'smooth' }); 

        } 

        // Close mobile menu if open 

        document.getElementById('mobile-menu').classList.add('hidden'); 

      } 

 

      // Desktop menu 

      document.getElementById('nav-home').addEventListener('click', () => scrollToSection('app')); 

      document.getElementById('nav-vouchers').addEventListener('click', () => { 

        const voucherSection = document.querySelector('h2'); 

        if (voucherSection) { 

          voucherSection.scrollIntoView({ behavior: 'smooth' }); 

        } 

        document.getElementById('mobile-menu').classList.add('hidden'); 

      }); 

      document.getElementById('nav-create').addEventListener('click', () => { 

        document.getElementById('create-modal').classList.remove('hidden'); 

        document.getElementById('mobile-menu').classList.add('hidden'); 

      }); 

      document.getElementById('nav-redeem').addEventListener('click', () => { 

        document.getElementById('redeem-modal').classList.remove('hidden'); 

        document.getElementById('mobile-menu').classList.add('hidden'); 

      }); 

 

      // Mobile menu 

      document.getElementById('mobile-nav-home').addEventListener('click', () => scrollToSection('app')); 

      document.getElementById('mobile-nav-vouchers').addEventListener('click', () => { 

        const voucherSection = document.querySelector('h2'); 

        if (voucherSection) { 

          voucherSection.scrollIntoView({ behavior: 'smooth' }); 

        } 

        document.getElementById('mobile-menu').classList.add('hidden'); 

      }); 

      document.getElementById('mobile-nav-create').addEventListener('click', () => { 

        document.getElementById('create-modal').classList.remove('hidden'); 

        document.getElementById('mobile-menu').classList.add('hidden'); 

      }); 

      document.getElementById('mobile-nav-redeem').addEventListener('click', () => { 

        document.getElementById('redeem-modal').classList.remove('hidden'); 

        document.getElementById('mobile-menu').classList.add('hidden'); 

      }); 

 

      // Event Listeners 

      document.getElementById('create-btn').addEventListener('click', () => { 

        document.getElementById('create-modal').classList.remove('hidden'); 

      }); 

 

      document.getElementById('redeem-btn').addEventListener('click', () => { 

        document.getElementById('redeem-modal').classList.remove('hidden'); 

      }); 

 

      document.getElementById('create-modal-backdrop').addEventListener('click', () => { 

        document.getElementById('create-modal').classList.add('hidden'); 

      }); 

 

      document.getElementById('redeem-modal-backdrop').addEventListener('click', () => { 

        document.getElementById('redeem-modal').classList.add('hidden'); 

      }); 

 

      document.getElementById('create-cancel-btn').addEventListener('click', () => { 

        document.getElementById('create-modal').classList.add('hidden'); 

        document.getElementById('create-form').reset(); 

      }); 

 

      document.getElementById('redeem-cancel-btn').addEventListener('click', () => { 

        document.getElementById('redeem-modal').classList.add('hidden'); 

        document.getElementById('redeem-form').reset(); 

      }); 

 

      document.getElementById('registration-form').addEventListener('submit', async (e) => { 

        e.preventDefault(); 

         

        const submitBtn = document.getElementById('register-btn'); 

        submitBtn.disabled = true; 

        submitBtn.textContent = 'Wird registriert...'; 

 

        // Simulate registration process 

        setTimeout(() => { 

          submitBtn.disabled = false; 

          submitBtn.textContent = 'Registrieren'; 

          showToast('Registrierung erfolgreich! Willkommen bei Babsy Partnergutscheinen!'); 

          document.getElementById('registration-form').reset(); 

        }, 1500); 

      }); 

 

      document.getElementById('create-form').addEventListener('submit', async (e) => { 

        e.preventDefault(); 

         

        if (vouchers.length >= 999) { 

          showToast('Maximale Anzahl von 999 Gutscheinen erreicht', 'error'); 

          return; 

        } 

 

        const submitBtn = document.getElementById('create-submit-btn'); 

        submitBtn.disabled = true; 

        submitBtn.textContent = 'Wird erstellt...'; 

 

        const selectedOption = document.getElementById('voucher-partner').value; 

        const [partner, title, description] = selectedOption.split('|'); 

         

        const session = localStorage.getItem('babsy_voucher_session');
        const currentUser = session ? JSON.parse(session) : null;

        const newVoucher = {

          id: Date.now().toString(),

          code: generateVoucherCode(),

          title: title,

          description: description,

          partner: partner,

          value: title,

          userId: currentUser?.userId || 'unknown',

          customerId: currentUser?.username || 'unknown',

          createdAt: new Date().toISOString(),

          redeemedAt: '',

          isRedeemed: false

        };



        vouchers.unshift(newVoucher);

        const saved = await saveVouchers();



        submitBtn.disabled = false;

        submitBtn.textContent = 'Erstellen';



        if (saved) {

          renderVouchers();

          showToast('Gutschein erfolgreich erstellt!');

          document.getElementById('create-modal').classList.add('hidden');

          document.getElementById('create-form').reset();

        } else {

          showToast('Fehler beim Erstellen des Gutscheins', 'error');

        } 

      }); 

 

      document.getElementById('redeem-form').addEventListener('submit', async (e) => { 

        e.preventDefault(); 

         

        const code = document.getElementById('redeem-code').value.toUpperCase(); 

        const voucher = vouchers.find(v => v.code === code && !v.isRedeemed); 

 

        const submitBtn = document.getElementById('redeem-submit-btn'); 

        submitBtn.disabled = true; 

        submitBtn.textContent = 'Wird eingel√∂st...'; 

 

        if (!voucher) { 

          submitBtn.disabled = false; 

          submitBtn.textContent = 'Einl√∂sen'; 

          showToast('Gutschein nicht gefunden oder bereits eingel√∂st', 'error'); 

          return; 

        } 

 

        voucher.isRedeemed = true;

        voucher.redeemedAt = new Date().toISOString();



        const saved = await saveVouchers();



        submitBtn.disabled = false;

        submitBtn.textContent = 'Einl√∂sen';



        if (saved) {

          renderVouchers();

          showToast('Gutschein erfolgreich eingel√∂st!');

          document.getElementById('redeem-modal').classList.add('hidden');

          document.getElementById('redeem-form').reset();

        } else {

          showToast('Fehler beim Einl√∂sen des Gutscheins', 'error');

        } 

      }); 

    } 

 

    init(); 

  </script> 

 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'997c4d52a6efb571',t:'MTc2MjAwOTY0OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body> 

</html> 